# Code Review

## General Strategies

Internally - Look for weaknesses, but not necessarily vulns
Externally - Look for vulns


Horizontal (check every fn in isolation)
* Lots of work
* Slow but complete

Vertical (follow call trees)
* Top-down (where can I put user input -> how is it used)
* Bottom-up (interesting fn -> how can I call it)

Grep for sensitive keywords
* Potential dead code paths
* Fast but incomplete

Functional (feature based)
* Can find one vuln across multiple apps; compare how they do it; notice inconsistencies

## URL Routing

Discover routes
* Controller classes
* Annotations/decorators

Discover parameters being injected in routes

## Reviewing

Dangerous code?
Interesting arguments?
Input filtering in place?
Can we bypass filtering (fuzz, test, google)?
Do we have access to control input?

## Filtering / Escaping

Naive filtering or escaping, i.e. blacklist specific known injections, can be bypassed.

Incomplete filtering or escaping, i.e. character blacklist but not everything needed, not considering double escapes, not considering repeat or nested injections.

* Replace vs ReplaceAll
* Contains rather than Starts/EndsWith

Incorrect context used
* filter/escape for JS string context in HTML attribute context.
* filter works for Linux but not Windows

Regex wrong
* Missing start/end of string?
* Not escaping special characters like `.`?
* Is regex multiline or not? Can we inject `\n` in our input? 
* Ignore case may match turkish i?

Modifications done AFTER filtering may have an impact.

Modifications or uses of input BEFORE filtering is done may also have an impact.

# Flaws

## Business Logic Flaws

Simple code bugs, e.g.

* OR `||` rather than AND `&&` expressions
* Complex expressions that may evaluate in unexpected ways, e.g. inappropriate `null` check or branches that are terminated early

## Common Weaknesses

Insecure defaults:

* Weak default valuees
* Conditions that are likely to result in insecure values being in use due to incomplete configuration, e.g. `if env=='production' then secret=env.secret else secret='secret'`

Inappropriate error handling:

* Error caught but function execution not terminated
* Error state from an Optional<> result not checked

Encryption issues:

* Concatenation of elements that may lead to collisions, e.g. `signature=hash(username + amount)` where where `username=user&amount=210` or `username=user2&amount=10`.
* Signature must have a separator between values, values must be encoded prior to escape separators included inside values
  * __Signing Oracle__ - Signatures should not be resuable in multiple features.  I.e. same key used in a sensitive location (e.g. build  password reset link) and another location (e.g. generate referral link) where an attacker can freely generate signatures that can be copied into the sensitive location.
  * Signatures should have an expiry date or be OTP so they can't be intercepted and reused forever

SQL Injection:

* Injectable inside value
* Injectable inside query statement, even if parameterised queries are used

HTML Injection:

* Not escaping values before injecting into HTML text
* Not escaping values before injecting into HTML attributes
* Using inconsistent single vs double quotes around HTML attributes

File handling:

* Inadequate filtering of directory traversal
* Not validating cleaned path is inside expected target path

Logging:

* Able to insert extra lines inside logs; could allow tampering by inserting fake lines
* Only last IP being logged in `req.ip` and not proxy headers like `req.ips`

## Golang

`ioutil.TempFile(folder, filename)` doesn't validate target folder location in older versions of the language.
`filepath.Join(dest, filename)` where filename may include user input with path traversals

## Javascript

